---
# Configuration specific to NAS node (pi-cm5-4)
# This node requires M.2 SATA controller support via PCIe

# Pi CM5 configuration for NAS node - storage node requiring M.2 controller
# PCIe enabled for M.2 SATA/NVMe controller support
pi_cm5_config_pcie_enabled: true # Required for M.2 SATA controller support

# PCIe generation speed for NAS node
# 3 = PCIe Gen3 for maximum NVMe performance (~2x faster than Gen2)
# Note: Gen3 not officially certified, may cause stability issues with some drives
pi_cm5_config_pcie_generation: 3

# POE configuration for NAS node
# Enable POE support for Waveshare PoE HAT (G) - not needed for cluster on Turing Pi 2
# Reference: https://www.waveshare.com/wiki/PoE_HAT_(G)#How_to_Install
pi_cm5_config_poe_enabled: true

# MinIO storage configuration for NAS node
# Uses persistent disk identifiers (WWN) to avoid device name changes
# Defines the drives to be prepared and used for MinIO data storage
minio_storage_drives:
  - device: /dev/disk/by-id/wwn-0x5000c5008a1a78df
    label: MINIODRIVE1
    mount_point: /mnt/minio-drive1
    filesystem: xfs
  - device: /dev/disk/by-id/wwn-0x5000c5008a1a7d0f
    label: MINIODRIVE2
    mount_point: /mnt/minio-drive2
    filesystem: xfs

# MinIO data directories - used by ricsanfre.minio role
# NEW: Single MergerFS mount point (see minio_storage_drives_new below)
# OLD: [/mnt/minio-drive1/data, /mnt/minio-drive2/data]
minio_server_datadirs:
  - /mnt/minio-storage

# MinIO mount options for /etc/fstab
# noatime = performance optimization for object storage workloads
minio_mount_options: "defaults,noatime"

# MinIO server configuration for ricsanfre.minio role
minio_root_user: "miniosuperuser"
minio_root_password: "{{ vault_minio_root_password }}"
minio_server_port: 9000
minio_console_port: 443
minio_enable_tls: true
# Server bind configuration - bind to all interfaces for external access
minio_server_addr: "" # Empty = bind to all interfaces (0.0.0.0)
# Client connection configuration - use proper domain name for SSL certificate compatibility
minio_server_address: "{{ minio_internal_domain }}"
# Scanner configuration - minimize disk access for spin-down compatibility
# Scanner runs periodically to check bucket usage and health
# Slowest speed + long cycle allows drives to spin down during idle
minio_server_env_extra: |
  # Scanner speed (slowest = minimize disk access)
  MINIO_SCANNER_SPEED="slowest"
  # Scanner cycle interval (time between scanner runs)
  MINIO_SCANNER_CYCLE="6h"
  # Disable bitrot scanning (prevents background disk reads)
  MINIO_HEAL_BITROTSCAN="off"
  # Increase healing sleep duration to reduce I/O frequency
  MINIO_HEAL_MAX_SLEEP="5s"
  # Disable drive health monitoring (prevents constant tmp file writes)
  _MINIO_DRIVE_ACTIVE_MONITORING="off"
# Certificate files will be provided via symlinks from minio-complete.yml
# Do not define minio_cert/minio_key to prevent overwriting Let's Encrypt symlinks
# minio_cert: "{{ minio_cert_path }}/public.crt"  # REMOVED - prevents symlink overwrite
# minio_key: "{{ minio_cert_path }}/private.key"   # REMOVED - prevents symlink overwrite

# MinIO buckets for different use cases
minio_buckets:
  - name: longhorn-backups
    policy: private
    # Object locking for backup integrity
    object_locking: true
  - name: restic-backups
    policy: private
    # Restic backup storage from Beelink
    object_locking: false
  - name: cluster-logs
    policy: private
  - name: media-storage
    policy: read-write

# MinIO users for service accounts
minio_users:
  - name: longhorn-backup
    password: "{{ vault_longhorn_backup_password }}"
    buckets_acl:
      - name: longhorn-backups
        policy: read-write
  - name: restic-backup
    password: "{{ vault_restic_backup_password }}"
    buckets_acl:
      - name: restic-backups
        policy: read-write
  - name: readonly-user
    password: "{{ vault_readonly_user_password }}"
    buckets_acl:
      - name: media-storage
        policy: read-only

# MinIO service accounts (S3 API access keys)
minio_service_accounts:
  - user: longhorn-backup
    access_key: "{{ vault_longhorn_s3_access_key }}"
    secret_key: "{{ vault_longhorn_s3_secret_key }}"
    description: "Longhorn backup S3 access"
  - user: restic-backup
    access_key: "{{ vault_restic_s3_access_key }}"
    secret_key: "{{ vault_restic_s3_secret_key }}"
    description: "Restic incremental backups from Beelink"

# Disable cgroups for NAS
pi_cm5_config_cgroup_enabled: false

# SSL Certificate configuration for NAS services
# Note: minio_internal_domain is defined in group_vars/all/main.yml
# (available to all hosts for backup and storage access)

# Let's Encrypt configuration
letsencrypt_email: "{{ vault_letsencrypt_email }}"

# Certificate deployment paths (align with MinIO role default)
minio_cert_path: "/etc/minio/ssl"
minio_user: "minio"

# Cloudflare API configuration for DNS-01 challenges
# This is the same token used by other services
cloudflare_api_token: "{{ vault_cloudflare_api_token }}"

# ============================================================================
# MergerFS + SnapRAID Configuration (New Architecture)
# ============================================================================
# This configuration adds redundancy to MinIO storage using MergerFS for
# pooling and SnapRAID for parity protection.
#
# Benefits:
# - Survive single disk failure (SnapRAID parity recovery)
# - Easy expansion (add more HDDs via SATA or USB)
# - Consistent architecture with Beelink storage
# - No LUKS encryption (MinIO provides HTTPS encryption in-transit)

# Storage Drives Configuration (Updated for MergerFS)
# ===================================================
# 2x 2TB HDD SATA drives
# OLD: Mounted separately at /mnt/minio-drive1 and /mnt/minio-drive2
# NEW: One data drive, one parity drive

minio_storage_drives_new:
  - device: /dev/disk/by-id/wwn-0x5000c5008a1a78df
    label: minio-data1
    mount_point: /mnt/minio-disk1
    filesystem: xfs
  - device: /dev/disk/by-id/wwn-0x5000c5008a1a7d0f
    label: minio-par1
    mount_point: /mnt/minio-parity1
    filesystem: xfs

# MergerFS Configuration for MinIO
# =================================
minio_mergerfs_mount: /mnt/minio-storage

# Data drives to pool (first drive only initially)
minio_mergerfs_data_drives:
  - /mnt/minio-disk1

# MergerFS mount options (same as Beelink for consistency)
minio_mergerfs_options: "defaults,allow_other,use_ino,cache.files=partial,dropcacheonclose=true,category.create=mfs"

# SnapRAID Configuration for MinIO
# =================================

# Parity file location
minio_snapraid_parity_drives:
  - /mnt/minio-parity1/snapraid.parity

# Data drives configuration
minio_snapraid_data_drives:
  - path: /mnt/minio-disk1
    name: d1

# Content file locations (metadata storage)
minio_snapraid_content_files:
  - /var/minio-snapraid.content
  - /mnt/minio-disk1/.snapraid.content

# Filesystem and mount options for new MergerFS setup
minio_filesystem: xfs  # Object storage optimized
minio_mount_options_new: "defaults,noatime"

# ============================================================================
# Disk Spin-Down Configuration (hdparm)
# ============================================================================
# Reduces power consumption and extends HDD lifespan during idle periods.
# MinIO S3 storage has infrequent access (backup storage only), making it
# ideal for automatic spin-down after extended idle periods.
#
# Power savings: ~5.5W per drive when spun down (~11W total for both drives)
#
# How it works:
# - hdparm -S sets timeout in 5-second units (360 * 5 = 1800 seconds = 30 minutes)
# - hdparm -B sets APM level (128 = balanced: enables spin-down, preserves performance)
# - udev rules ensure settings persist across reboots
# - Drives automatically spin up on-demand when accessed (transparent to MinIO)

# Spin-down timeout: hdparm -S parameter (0-255)
# 1-240 = (value * 5) seconds, 241-251 = (value-240) * 30 minutes
# 60 = 5 minutes (60 * 5 = 300 seconds)
minio_disk_spindown_timeout: 60

# Advanced Power Management level (1-255)
# 128-254 = performance mode with APM enabled (128=balanced, 254=max perf)
# 1-127 = power saving mode (1=max power save, 127=moderate)
# 255 = disable APM
minio_disk_apm_level: 128

# List of disk device identifiers to configure for spin-down
# Uses WWN identifiers (stable across reboots, not affected by /dev/sdX changes)
minio_spindown_devices:
  - /dev/disk/by-id/wwn-0x5000c5008a1a78df  # minio-disk1 (data)
  - /dev/disk/by-id/wwn-0x5000c5008a1a7d0f  # minio-parity1 (parity)
