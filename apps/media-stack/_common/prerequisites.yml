---
# Media Stack Prerequisites
# Shared storage infrastructure for all media applications
# Creates namespace, PVC, and initializes directory structure

- name: Create media-stack-data PersistentVolumeClaim
  kubernetes.core.k8s:
    definition:
      apiVersion: v1
      kind: PersistentVolumeClaim
      metadata:
        name: media-stack-data
        namespace: media
        labels:
          app: media-stack
          managed-by: ansible
      spec:
        accessModes:
          - ReadWriteOnce
        storageClassName: longhorn
        resources:
          requests:
            storage: 1Ti
    state: present
    kubeconfig: /etc/rancher/k3s/k3s.yaml

- name: Check if directory initialization has already completed
  kubernetes.core.k8s_info:
    api_version: batch/v1
    kind: Job
    name: media-stack-init-dirs
    namespace: media
    kubeconfig: /etc/rancher/k3s/k3s.yaml
  register: init_job_status

- name: Initialize media stack directory structure
  kubernetes.core.k8s:
    definition:
      apiVersion: batch/v1
      kind: Job
      metadata:
        name: media-stack-init-dirs
        namespace: media
        labels:
          app: media-stack
          managed-by: ansible
      spec:
        ttlSecondsAfterFinished: 300 # Cleanup job 5 minutes after completion
        backoffLimit: 3
        template:
          metadata:
            labels:
              app: media-stack-init
          spec:
            restartPolicy: OnFailure
            containers:
              - name: init-directories
                image: busybox:1.36
                command:
                  - sh
                  - -c
                  - |
                    echo "Creating media stack directory structure..."
                    mkdir -p /data/torrents/movies
                    mkdir -p /data/torrents/tv
                    mkdir -p /data/torrents/incomplete
                    mkdir -p /data/media/movies
                    mkdir -p /data/media/tv
                    chmod -R 777 /data
                    echo "Directory structure created:"
                    ls -laR /data
                    echo "Initialization complete!"
                volumeMounts:
                  - name: data
                    mountPath: /data
                resources:
                  requests:
                    cpu: 10m
                    memory: 32Mi
                  limits:
                    cpu: 50m
                    memory: 64Mi
            volumes:
              - name: data
                persistentVolumeClaim:
                  claimName: media-stack-data
    state: present
    kubeconfig: /etc/rancher/k3s/k3s.yaml
  when: init_job_status.resources | length == 0

- name: Wait for directory initialization job to complete
  kubernetes.core.k8s_info:
    api_version: batch/v1
    kind: Job
    name: media-stack-init-dirs
    namespace: media
    kubeconfig: /etc/rancher/k3s/k3s.yaml
    wait: true
    wait_condition:
      type: Complete
      status: "True"
    wait_timeout: 300
  when: init_job_status.resources | length == 0
