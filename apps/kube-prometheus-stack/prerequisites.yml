---
# Prerequisites for kube-prometheus-stack
# Creates NetworkPolicy to allow Prometheus to scrape targets

- name: Create NetworkPolicy for Prometheus scraping
  kubernetes.core.k8s:
    definition:
      apiVersion: networking.k8s.io/v1
      kind: NetworkPolicy
      metadata:
        name: allow-prometheus-scraping
        namespace: monitoring
      spec:
        podSelector:
          matchLabels:
            app.kubernetes.io/name: prometheus
        policyTypes:
          - Egress
        egress:
          # Kubernetes API for service discovery (control plane nodes)
          - to:
              - ipBlock:
                  cidr: 192.168.1.0/24
            ports:
              - port: 6443
                protocol: TCP
              - port: 9100
                protocol: TCP
              - port: 10250
                protocol: TCP
          # Scrape kube-system pods (kubelet, coredns, etc.)
          - to:
              - namespaceSelector:
                  matchLabels:
                    kubernetes.io/metadata.name: kube-system
            ports:
              - port: 10250
                protocol: TCP
              - port: 10255
                protocol: TCP
              - port: 9153
                protocol: TCP
          # Scrape pods in all namespaces (for ServiceMonitors)
          - to:
              - namespaceSelector: {}
            ports:
              - port: 8080
                protocol: TCP
              - port: 8443
                protocol: TCP
              - port: 9090
                protocol: TCP
              - port: 9093
                protocol: TCP
              - port: 9100
                protocol: TCP
    kubeconfig: /etc/rancher/k3s/k3s.yaml

- name: Create NetworkPolicy for Grafana sidecars
  kubernetes.core.k8s:
    definition:
      apiVersion: networking.k8s.io/v1
      kind: NetworkPolicy
      metadata:
        name: allow-grafana-k8s-api
        namespace: monitoring
      spec:
        podSelector:
          matchLabels:
            app.kubernetes.io/name: grafana
        policyTypes:
          - Egress
        egress:
          # DNS resolution via CoreDNS
          - to:
              - namespaceSelector:
                  matchLabels:
                    kubernetes.io/metadata.name: kube-system
            ports:
              - port: 53
                protocol: TCP
              - port: 53
                protocol: UDP
          # Kubernetes API (DNAT'd to control plane nodes)
          - to:
              - ipBlock:
                  cidr: 192.168.1.0/24
            ports:
              - port: 6443
                protocol: TCP
          # Prometheus and Alertmanager in monitoring namespace
          - to:
              - namespaceSelector:
                  matchLabels:
                    kubernetes.io/metadata.name: monitoring
            ports:
              - port: 9090
                protocol: TCP
              - port: 9093
                protocol: TCP
    kubeconfig: /etc/rancher/k3s/k3s.yaml
