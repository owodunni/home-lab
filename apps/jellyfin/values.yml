---
# Helm values for Jellyfin
# Uses official Jellyfin Helm chart

image:
  repository: jellyfin/jellyfin
  tag: 10.8.13
  pullPolicy: IfNotPresent

env:
  TZ: "Europe/Amsterdam"

service:
  type: ClusterIP
  port: 8096

ingress:
  enabled: true
  className: traefik
  annotations:
    traefik.ingress.kubernetes.io/router.entrypoints: websecure
    cert-manager.io/cluster-issuer: letsencrypt-prod
  hosts:
    - host: jellyfin.jardoole.xyz
      paths:
        - path: /
          pathType: Prefix
  tls:
    - secretName: jellyfin-tls
      hosts:
        - jellyfin.jardoole.xyz

persistence:
  config:
    enabled: true
    storageClass: longhorn
    accessMode: ReadWriteOnce
    size: 10Gi  # Expanded from 2Gi to accommodate transcodes

  media:
    enabled: true
    type: pvc
    existingClaim: media-stack-data

# Node affinity for Beelink node
affinity:
  nodeAffinity:
    requiredDuringSchedulingIgnoredDuringExecution:
      nodeSelectorTerms:
        - matchExpressions:
            - key: kubernetes.io/hostname
              operator: In
              values:
                - beelink

# Security context with Intel GPU access for hardware transcoding
podSecurityContext:
  runAsUser: 1000
  runAsGroup: 1000
  fsGroup: 1000
  supplementalGroups:
    - 44   # video group - grants access to /dev/dri
    - 992  # render group - grants access to GPU render nodes

securityContext:
  allowPrivilegeEscalation: false
  readOnlyRootFilesystem: false

# Intel QuickSync hardware transcoding - mount /dev/dri for GPU access
volumes:
  - name: dri-device
    hostPath:
      path: /dev/dri
      type: Directory

volumeMounts:
  - name: dri-device
    mountPath: /dev/dri
