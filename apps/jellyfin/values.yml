---
# Helm values for Jellyfin
# Uses bjw-s app-template pattern with hardware transcoding support

controllers:
  jellyfin:
    containers:
      app:
        image:
          repository: lscr.io/linuxserver/jellyfin
          tag: 10.11.2
          pullPolicy: IfNotPresent

        env:
          - name: PUID
            value: "1000"
          - name: PGID
            value: "1000"
          - name: TZ
            value: "Europe/Amsterdam"

        # Request Intel GPU for QuickSync hardware transcoding
        resources:
          requests:
            cpu: 200m
            memory: 512Mi
            gpu.intel.com/i915: 1
          limits:
            cpu: 2000m
            memory: 4Gi
            gpu.intel.com/i915: 1

        probes:
          liveness:
            enabled: true
            custom: true
            spec:
              httpGet:
                path: /health
                port: 8096
              initialDelaySeconds: 60
              periodSeconds: 30
              timeoutSeconds: 5
          readiness:
            enabled: true
            custom: true
            spec:
              httpGet:
                path: /health
                port: 8096
              initialDelaySeconds: 30
              periodSeconds: 10
              timeoutSeconds: 5

service:
  app:
    controller: jellyfin
    ports:
      http:
        port: 8096

ingress:
  app:
    enabled: true
    className: traefik
    annotations:
      traefik.ingress.kubernetes.io/router.entrypoints: websecure
      cert-manager.io/cluster-issuer: letsencrypt-prod
      # Homepage auto-discovery
      gethomepage.dev/enabled: "true"
      gethomepage.dev/name: "Jellyfin"
      gethomepage.dev/description: "Media Server"
      gethomepage.dev/group: "Media"
      gethomepage.dev/icon: "jellyfin.png"
    hosts:
      - host: jellyfin.jardoole.xyz
        paths:
          - path: /
            pathType: Prefix
            service:
              identifier: app
              port: http
    tls:
      - secretName: jellyfin-tls
        hosts:
          - jellyfin.jardoole.xyz

persistence:
  config:
    enabled: true
    type: persistentVolumeClaim
    storageClass: longhorn
    accessMode: ReadWriteOnce
    size: 10Gi # Expanded from 2Gi to accommodate transcodes
    retain: true
    globalMounts:
      - path: /config

  media:
    enabled: true
    type: hostPath
    hostPath: /mnt/storage/media-media-stack-data
    globalMounts:
      - path: /media

  # Mount /dev/dri from host for GPU access
  dri-devices:
    enabled: true
    type: hostPath
    hostPath: /dev/dri
    globalMounts:
      - path: /dev/dri
        readOnly: false

  # Mount host's VA-API drivers over container's bundled drivers
  # Host drivers (May 2024) support Intel N150, container's (Nov 2023) do not
  va-drivers:
    enabled: true
    type: hostPath
    hostPath: /usr/lib/x86_64-linux-gnu/dri
    globalMounts:
      - path: /usr/lib/jellyfin-ffmpeg/lib/dri
        readOnly: true

  # Mount Intel Graphics Memory Management library (required by iHD driver)
  igdgmm-lib:
    enabled: true
    type: hostPath
    hostPath: /usr/lib/x86_64-linux-gnu/libigdgmm.so.12
    globalMounts:
      - path: /usr/lib/x86_64-linux-gnu/libigdgmm.so.12
        readOnly: true

  # Mount oneVPL runtime library (Intel Video Processing Library)
  # Required for QSV hardware encoding to work with modern VA-API drivers
  # Container's bundled libvpl v2.15 is incompatible with host VA-API driver v25.2.3
  onevpl-runtime:
    enabled: true
    type: hostPath
    hostPath: /usr/lib/x86_64-linux-gnu
    globalMounts:
      - path: /usr/lib/jellyfin-ffmpeg/lib/onevpl-host
        readOnly: true

  # Mount Intel VPL GPU Runtime (libmfx-gen)
  # Required for QSV hardware filters (scale_qsv, vpp_qsv, overlay_qsv)
  # Must match VA-API driver version for proper QSV pipeline functionality
  mfx-gen-runtime:
    enabled: true
    type: hostPath
    hostPath: /usr/lib/x86_64-linux-gnu/libmfx-gen
    globalMounts:
      - path: /usr/lib/jellyfin-ffmpeg/lib/libmfx-gen
        readOnly: true

# Node affinity and security context
defaultPodOptions:
  # Run on Beelink node (has Intel GPU)
  affinity:
    nodeAffinity:
      requiredDuringSchedulingIgnoredDuringExecution:
        nodeSelectorTerms:
          - matchExpressions:
              - key: kubernetes.io/hostname
                operator: In
                values:
                  - beelink

  # LinuxServer.io images handle user/group internally via PUID/PGID
  # GPU device access managed by Intel GPU device plugin + hostPath mounts
  securityContext: {}
