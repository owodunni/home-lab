---
# Master orchestration playbook for home lab infrastructure
# Executes base configuration in the correct order for full cluster setup

- name: Home Lab Infrastructure Setup
  hosts: localhost
  gather_facts: false
  tasks:
    - name: Display setup overview
      ansible.builtin.debug:
        msg: |
          Home Lab Infrastructure Setup
          ============================

          Target Infrastructure:
          - K3s Cluster: pi-cm5-1 (control), pi-cm5-2,3 (workers), Beelink (storage worker)
          - NAS: pi-cm5-4 (MinIO S3 backup server)

          Execution Order:
          1. Base Pi CM5 configuration (all Pi nodes)
          2. System upgrades and security updates
          3. Storage configuration (NAS node disk preparation)
          4. MinIO S3 backup service installation
          5. K3s cluster installation (3-node HA with embedded etcd)

          Future Steps (see TODO.md):
          - Longhorn distributed storage
          - Integration and monitoring

# Phase 1: Base Configuration for all Pi CM5 nodes
- name: Phase 1 - Base Pi CM5 Configuration
  import_playbook: playbooks/pi-base-config.yml

# Phase 2: System maintenance - establish clean base before applications
- name: Phase 2a - System Upgrades
  import_playbook: playbooks/upgrade.yml
- name: Phase 2b - Unattended Upgrades Setup
  import_playbook: playbooks/unattended-upgrades.yml

# Phase 3: Storage-specific configuration for NAS node
- name: Phase 3 - Storage Configuration
  import_playbook: playbooks/pi-storage-config.yml

# Phase 4: MinIO S3 backup service installation
- name: Phase 4 - MinIO S3 Installation
  import_playbook: playbooks/minio-setup.yml

# Phase 5: K3s cluster installation
- name: Phase 5 - K3s HA Cluster Installation
  import_playbook: playbooks/k3s-cluster.yml

# Final status summary
- name: Setup Complete
  hosts: localhost
  gather_facts: false
  tasks:
    - name: Display completion status
      ansible.builtin.debug:
        msg: |
          Infrastructure Setup Complete!
          =============================

          ✓ Base Pi CM5 configuration applied
          ✓ System updates completed on clean base
          ✓ Unattended upgrades configured
          ✓ Storage configuration applied to NAS (4TB XFS ready)
          ✓ MinIO S3 backup service installed and configured
          ✓ K3s HA cluster deployed (3-node with embedded etcd)

          Service Access:
          - MinIO Console: http://pi-cm5-4.local:9001
          - MinIO API: http://pi-cm5-4.local:9000
          - K3s API: https://pi-cm5-1:6443 (or pi-cm5-2, pi-cm5-3)
          - MinIO Buckets: longhorn-backups, cluster-logs, media-storage

          Next Steps:
          1. Test K3s cluster: kubectl get nodes
          2. Install Longhorn distributed storage with MinIO backup
          3. Set up application workloads and monitoring

          Note: System reboots handled automatically during upgrade phase.

          Run 'make site-check' to preview changes before execution.
