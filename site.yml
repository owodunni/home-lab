---
# Master orchestration playbook for home lab infrastructure
# Executes base configuration in the correct order for full cluster setup

- name: Home Lab Infrastructure Setup
  hosts: localhost
  gather_facts: false
  tasks:
    - name: Display setup overview
      ansible.builtin.debug:
        msg: |
          Home Lab Infrastructure Setup
          ============================

          Target Infrastructure:
          - K3s Cluster: pi-cm5-1 (control), pi-cm5-2,3 (workers), Beelink (storage worker)
          - NAS: pi-cm5-4 (MinIO S3 backup server)

          Execution Order:
          1. Base Pi CM5 configuration (all Pi nodes)
          2. System upgrades and security updates
          3. Storage configuration (NAS node disk preparation)
          4. MinIO S3 backup service installation

          Future Steps (see TODO.md):
          - K3s cluster installation
          - Longhorn distributed storage
          - Integration and monitoring

# Phase 1: Base Configuration for all Pi CM5 nodes
- name: Phase 1 - Base Pi CM5 Configuration
  import_playbook: playbooks/pi-base-config.yml

# Phase 2: System maintenance - establish clean base before applications
- name: Phase 2a - System Upgrades
  import_playbook: playbooks/upgrade.yml
- name: Phase 2b - Unattended Upgrades Setup
  import_playbook: playbooks/unattended-upgrades.yml

# Phase 3: Storage-specific configuration for NAS node
- name: Phase 3 - Storage Configuration
  import_playbook: playbooks/pi-storage-config.yml

# Phase 4: MinIO S3 backup service installation
- name: Phase 4 - MinIO S3 Installation
  import_playbook: playbooks/minio-setup.yml

# Final status summary
- name: Setup Complete
  hosts: localhost
  gather_facts: false
  tasks:
    - name: Display completion status
      ansible.builtin.debug:
        msg: |
          Infrastructure Setup Complete!
          =============================

          ✓ Base Pi CM5 configuration applied
          ✓ System updates completed on clean base
          ✓ Unattended upgrades configured
          ✓ Storage configuration applied to NAS (4TB XFS ready)
          ✓ MinIO S3 backup service installed and configured

          MinIO Access:
          - Console: http://pi-cm5-4.local:9001
          - API: http://pi-cm5-4.local:9000
          - Buckets: longhorn-backups, cluster-logs, media-storage

          Next Steps:
          1. Test MinIO installation (see TODO.md usage guide)
          2. Follow TODO.md for K3s cluster setup
          3. Install Longhorn with MinIO backup integration

          Note: System reboots handled automatically during upgrade phase.

          Run 'make site-check' to preview changes before execution.
