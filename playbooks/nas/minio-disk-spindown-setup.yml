---
# Disk spin-down configuration for MinIO NAS storage
#
# WHY: Reduce power consumption and extend HDD lifespan during idle periods
#
# MinIO NAS uses 2x 2TB SATA HDDs for S3 backup storage (Longhorn and restic backups).
# These drives are accessed infrequently, making them ideal for automatic spin-down
# to save power (~11W when both drives are spun down).
#
# Configuration:
#   - Spin-down timeout: 30 minutes of inactivity
#   - APM level: 128 (balanced - enables spin-down while preserving performance)
#   - Persistence: udev rules automatically reapply settings on boot
#   - On-demand spin-up: Drives transparently spin up when accessed (~5-10 second delay)
#
# Implementation:
#   - hdparm package provides disk power management utilities
#   - udev rules match drives by WWN (stable identifier, not affected by /dev/sdX changes)
#   - Settings applied immediately without reboot
#
# Safety:
#   - No data risk: spin-down only affects power state, not data integrity
#   - MinIO compatible: S3 operations handle spin-up delays gracefully (built-in retries)
#   - Backup safe: Drives automatically spin up when accessed by backup jobs
#   - Reversible: Remove udev rules and reboot to disable
#
# Expected behavior:
#   - Backup runs → drives spin up automatically
#   - Backup completes → drives idle
#   - After 30 minutes idle → drives spin down
#   - Next backup → drives spin up automatically
#
# Power savings: ~5.5W per drive during idle periods (~11W total)
#
# WHAT: Install hdparm and configure automatic disk spin-down via udev rules

- name: Configure disk spin-down for MinIO NAS HDDs
  hosts: nas
  become: true

  tasks:
    # ========================================================================
    # Phase 1: Install hdparm
    # ========================================================================

    - name: Update apt cache
      ansible.builtin.apt:
        update_cache: true
        cache_valid_time: 3600  # 1 hour in seconds

    - name: Install hdparm package
      ansible.builtin.apt:
        name: hdparm
        state: present

    # ========================================================================
    # Phase 2: Configure udev rules for persistent spin-down
    # ========================================================================
    # udev rules apply settings automatically on boot and device hotplug
    # Using ACTION=="add|change" ensures settings apply when drives are detected

    - name: Create udev rule for disk spin-down
      ansible.builtin.copy:
        dest: /etc/udev/rules.d/69-hdparm-spindown.rules
        mode: "0644"
        owner: root
        group: root
        content: |
          # Automatic disk spin-down for MinIO NAS storage drives
          # Generated by Ansible - do not edit manually
          # Applies hdparm settings on boot and device changes

          # MinIO data drive (minio-disk1)
          ACTION=="add|change", ENV{ID_WWN}=="0x5000c5008a1a78df", \
            RUN+="/usr/sbin/hdparm -S {{ minio_disk_spindown_timeout }} -B {{ minio_disk_apm_level }} /dev/%k"

          # MinIO parity drive (minio-parity1)
          ACTION=="add|change", ENV{ID_WWN}=="0x5000c5008a1a7d0f", \
            RUN+="/usr/sbin/hdparm -S {{ minio_disk_spindown_timeout }} -B {{ minio_disk_apm_level }} /dev/%k"
      notify: Reload udev rules

    # ========================================================================
    # Phase 3: Apply settings immediately (without reboot)
    # ========================================================================

    - name: Apply spin-down settings to drives immediately
      ansible.builtin.command:
        cmd: "hdparm -S {{ minio_disk_spindown_timeout }} -B {{ minio_disk_apm_level }} {{ item }}"
      loop: "{{ minio_spindown_devices }}"
      register: hdparm_result
      changed_when: true

    - name: Display hdparm configuration results
      ansible.builtin.debug:
        msg: "{{ hdparm_result.results | map(attribute='stdout_lines') | list }}"

    # ========================================================================
    # Phase 4: Verification
    # ========================================================================

    - name: Verify current hdparm settings
      ansible.builtin.command:
        cmd: "hdparm -I {{ item }}"
      loop: "{{ minio_spindown_devices }}"
      register: hdparm_verify
      changed_when: false

    - name: Calculate timeout in minutes
      ansible.builtin.set_fact:
        timeout_minutes: >-
          {{
            (minio_disk_spindown_timeout * 5) // 60
            if minio_disk_spindown_timeout <= 240
            else (minio_disk_spindown_timeout - 240) * 30
          }}

    - name: Display verification summary
      ansible.builtin.debug:
        msg: |
          ╔══════════════════════════════════════════════════════════════╗
          ║      MinIO Disk Spin-Down Configuration Complete! ✓         ║
          ╠══════════════════════════════════════════════════════════════╣
          ║ Configuration:                                               ║
          ║  • Spin-down timeout: {{ timeout_minutes }} minutes                          ║
          ║  • APM level: {{ minio_disk_apm_level }} (balanced power/performance)            ║
          ║  • Devices configured: {{ minio_spindown_devices | length }}                                  ║
          ║                                                              ║
          ║ Configured Drives:                                           ║
          ║  • {{ minio_spindown_devices[0] | basename }}             ║
          ║  • {{ minio_spindown_devices[1] | basename }}             ║
          ║                                                              ║
          ║ Persistence:                                                 ║
          ║  • udev rule: /etc/udev/rules.d/69-hdparm-spindown.rules   ║
          ║  • Applied on: boot, device hotplug                         ║
          ║                                                              ║
          ║ Verification Commands:                                       ║
          ║  • Check current settings:                                   ║
          ║    hdparm -I /dev/disk/by-id/wwn-0x5000c5008a1a78df | grep -i "power"  ║
          ║                                                              ║
          ║  • Monitor disk state:                                       ║
          ║    hdparm -C /dev/disk/by-id/wwn-0x5000c5008a1a78df         ║
          ║                                                              ║
          ║  • Force immediate spin-down (testing):                      ║
          ║    hdparm -y /dev/disk/by-id/wwn-0x5000c5008a1a78df         ║
          ╚══════════════════════════════════════════════════════════════╝

  handlers:
    # Reload udev rules without reboot
    - name: Reload udev rules
      ansible.builtin.command:
        cmd: udevadm control --reload-rules
      changed_when: true

    - name: Trigger udev rules
      ansible.builtin.command:
        cmd: udevadm trigger
      changed_when: true
