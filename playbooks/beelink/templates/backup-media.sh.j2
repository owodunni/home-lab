#!/bin/bash
# Restic backup script for Beelink media storage
# Generated by Ansible - do not edit manually
#
# This script backs up /mnt/storage/media to MinIO S3
# Schedule: Daily at 3:00 AM via systemd timer
# Retention: 7 daily, 4 weekly, 6 monthly snapshots

set -e  # Exit on error
set -u  # Exit on undefined variable

# Configuration
export RESTIC_PASSWORD_FILE=/root/.restic-password
export AWS_ACCESS_KEY_ID="{{ vault_restic_s3_access_key }}"
export AWS_SECRET_ACCESS_KEY="{{ vault_restic_s3_secret_key }}"

RESTIC_REPO="s3:https://{{ minio_internal_domain }}:9000/restic-backups"
BACKUP_SOURCE="/mnt/storage/media"
LOG_FILE="/var/log/restic-backup.log"

# Logging function
log() {
    echo "[$(date +'%Y-%m-%d %H:%M:%S')] $*" | tee -a "$LOG_FILE"
}

# Start backup
log "==== Restic Backup Started ===="

# Check if source directory exists
if [ ! -d "$BACKUP_SOURCE" ]; then
    log "ERROR: Backup source directory does not exist: $BACKUP_SOURCE"
    exit 1
fi

# Backup k8s-apps directory (application configs)
log "Backing up /mnt/storage/k8s-apps"
restic -r "$RESTIC_REPO" backup /mnt/storage/k8s-apps \
    --tag=k8s-apps \
    --verbose 2>&1 | tee -a "$LOG_FILE"

K8S_BACKUP_EXIT_CODE=${PIPESTATUS[0]}

if [ $K8S_BACKUP_EXIT_CODE -ne 0 ]; then
    log "WARNING: k8s-apps backup failed with exit code $K8S_BACKUP_EXIT_CODE"
fi

# Backup media directory
log "Backing up $BACKUP_SOURCE to $RESTIC_REPO"
restic -r "$RESTIC_REPO" backup "$BACKUP_SOURCE" \
    --exclude="$BACKUP_SOURCE/torrents/incomplete" \
    --exclude="*.tmp" \
    --exclude="*.part" \
    --tag=media \
    --verbose 2>&1 | tee -a "$LOG_FILE"

BACKUP_EXIT_CODE=${PIPESTATUS[0]}

if [ $BACKUP_EXIT_CODE -ne 0 ]; then
    log "ERROR: Backup failed with exit code $BACKUP_EXIT_CODE"
    exit $BACKUP_EXIT_CODE
fi

log "Backup completed successfully"

# Cleanup old backups
log "Cleaning up old snapshots"
restic -r "$RESTIC_REPO" forget \
    --keep-daily 7 \
    --keep-weekly 4 \
    --keep-monthly 6 \
    --prune \
    --verbose 2>&1 | tee -a "$LOG_FILE"

FORGET_EXIT_CODE=${PIPESTATUS[0]}

if [ $FORGET_EXIT_CODE -ne 0 ]; then
    log "WARNING: Cleanup failed with exit code $FORGET_EXIT_CODE"
fi

# Verify backup integrity (5% data check)
log "Verifying backup integrity (5% sample)"
restic -r "$RESTIC_REPO" check \
    --read-data-subset=5% \
    --verbose 2>&1 | tee -a "$LOG_FILE"

CHECK_EXIT_CODE=${PIPESTATUS[0]}

if [ $CHECK_EXIT_CODE -ne 0 ]; then
    log "WARNING: Integrity check failed with exit code $CHECK_EXIT_CODE"
fi

# Display statistics
log "Backup statistics:"
restic -r "$RESTIC_REPO" snapshots --last | tee -a "$LOG_FILE"
restic -r "$RESTIC_REPO" stats --mode raw-data | tee -a "$LOG_FILE"

log "==== Restic Backup Completed ===="

exit 0
