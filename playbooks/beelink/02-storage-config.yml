---
# Beelink storage configuration playbook
# Configures LUKS-encrypted LVM storage for Longhorn on Beelink NAS server
# Architecture: 3x NVMe drives → LUKS encryption → LVM → ext4 → /var/lib/longhorn
- name: Configure Beelink storage for Longhorn
  hosts: beelink
  become: true

  tasks:
    # Install required packages for encryption and LVM
    # https://docs.ansible.com/ansible/latest/collections/ansible/builtin/apt_module.html
    - name: Install cryptsetup and LVM tools
      ansible.builtin.apt:
        name:
          - cryptsetup
          - cryptsetup-initramfs # Provides initramfs hooks for crypttab processing
          - lvm2
        state: present
        update_cache: true
        cache_valid_time: 3600 # 1 hour

    # Ensure directory exists for LUKS key file
    - name: Create directory for LUKS key file
      ansible.builtin.file:
        path: /root/.luks
        state: directory
        mode: "0700"
        owner: root
        group: root

    # Copy encrypted LUKS key file (ansible-vault auto-decrypts)
    # The key file is encrypted with ansible-vault and will be decrypted during copy
    - name: Copy LUKS key file to server
      ansible.builtin.copy:
        src: "{{ luks_key_file }}"
        dest: /root/.luks/beelink-luks.key
        mode: "0600"
        owner: root
        group: root

    # Initialize LUKS encryption and open devices
    # community.crypto.luks_device handles both format and open operations
    # state: opened ensures device is encrypted (formats if needed) and opened
    # https://docs.ansible.com/ansible/latest/collections/community/crypto/luks_device_module.html
    - name: Initialize LUKS encryption and open devices
      community.crypto.luks_device:
        device: "{{ item.device }}"
        name: "{{ item.name }}"
        state: opened
        keyfile: /root/.luks/beelink-luks.key
      loop: "{{ luks_crypt_devices }}"

    # Configure /etc/crypttab for automatic unlock on boot
    # This allows the system to unlock encrypted drives at boot using the key file
    # The 'initramfs' option forces inclusion in initramfs even for non-root filesystems
    - name: Configure crypttab for automatic LUKS unlock
      ansible.builtin.lineinfile:
        path: /etc/crypttab
        regexp: '^{{ item.name }}\s+'
        line: "{{ item.name }} {{ item.device }} /root/.luks/beelink-luks.key luks,initramfs"
        state: present
        create: true
        mode: "0644"
        backup: true
      loop: "{{ luks_crypt_devices }}"

    # Configure cryptsetup-initramfs to include LUKS key files in initramfs
    # Without KEYFILE_PATTERN, no key files are copied to initramfs and auto-unlock fails
    # The pattern must match the key file path referenced in /etc/crypttab
    - name: Configure cryptsetup-initramfs key file pattern
      ansible.builtin.lineinfile:
        path: /etc/cryptsetup-initramfs/conf-hook
        regexp: '^#?KEYFILE_PATTERN='
        line: 'KEYFILE_PATTERN="/root/.luks/*.key"'
        state: present
        backup: true

    # Set restrictive umask for initramfs to protect private key material
    # UMASK=0077 ensures only root can read the initramfs image containing LUKS keys
    # Without this, key files in initramfs are readable by all users (security risk)
    - name: Set secure umask for initramfs
      ansible.builtin.lineinfile:
        path: /etc/initramfs-tools/initramfs.conf
        regexp: '^UMASK='
        line: 'UMASK=0077'
        state: present
        backup: true

    # Rebuild initramfs to include crypttab configuration for early boot
    # Required: LUKS devices must unlock during initramfs stage (before mounting filesystems)
    # Without this, boot fails with "Timed out waiting for device" errors
    # The cryptsetup-initramfs package provides hooks, but initramfs must be rebuilt to activate them
    # https://wiki.debian.org/InitramfsDebug
    - name: Update initramfs to include LUKS configuration
      ansible.builtin.command:
        cmd: update-initramfs -u -k all
      register: initramfs_update
      changed_when: "'update-initramfs: Generating' in initramfs_update.stdout"

    # Create LVM volume group from encrypted devices
    # Ansible lvg module handles pvcreate and vgcreate automatically
    # Idempotent - safe to run multiple times
    # https://docs.ansible.com/ansible/latest/collections/community/general/lvg_module.html
    - name: Create LVM volume group
      community.general.lvg:
        vg: "{{ lvm_volume_group }}"
        pvs: "{% for item in luks_crypt_devices %}/dev/mapper/{{ item.name }}{% if not loop.last %},{% endif %}{% endfor %}"
        state: present

    # Create LVM logical volume using all available space
    # Ansible lvol module handles lvcreate automatically
    # size: 100%FREE allocates all free space in the volume group
    # shrink: false prevents accidental shrinking on subsequent runs
    # resizefs: false prevents filesystem resize attempts (handled separately)
    # https://docs.ansible.com/ansible/latest/collections/community/general/lvol_module.html
    - name: Create LVM logical volume
      community.general.lvol:
        vg: "{{ lvm_volume_group }}"
        lv: "{{ lvm_logical_volume }}"
        size: "{{ lvm_volume_size }}"
        state: present
        shrink: false
        resizefs: false

    # Format logical volume with ext4 filesystem
    # Idempotent - only formats if no filesystem exists
    # https://docs.ansible.com/ansible/latest/collections/community/general/filesystem_module.html
    - name: Create ext4 filesystem on logical volume
      community.general.filesystem:
        fstype: "{{ longhorn_filesystem }}"
        dev: /dev/{{ lvm_volume_group }}/{{ lvm_logical_volume }}

    # Create mount point directory for Longhorn
    - name: Create Longhorn mount point
      ansible.builtin.file:
        path: "{{ longhorn_mount_point }}"
        state: directory
        mode: "0755"
        owner: root
        group: root

    # Configure /etc/fstab for persistent mount
    # This ensures the filesystem mounts automatically on boot
    # https://docs.ansible.com/ansible/latest/collections/ansible/posix/mount_module.html
    - name: Configure fstab entry for Longhorn storage
      ansible.posix.mount:
        path: "{{ longhorn_mount_point }}"
        src: /dev/{{ lvm_volume_group }}/{{ lvm_logical_volume }}
        fstype: "{{ longhorn_filesystem }}"
        opts: "{{ longhorn_mount_options }}"
        state: mounted
        backup: true

    # Display storage configuration summary
    - name: Display storage configuration summary
      ansible.builtin.debug:
        msg: |
          Beelink storage configuration complete!

          Configuration:
          - Encryption: LUKS with key file in /root/.luks/
          - Storage pool: {{ lvm_volume_group }} ({{ luks_crypt_devices | length }} drives)
          - Logical volume: /dev/{{ lvm_volume_group }}/{{ lvm_logical_volume }}
          - Filesystem: {{ longhorn_filesystem }}
          - Mount point: {{ longhorn_mount_point }}
          - Mount options: {{ longhorn_mount_options }}

          Encrypted devices:
          {% for item in luks_crypt_devices %}
          - {{ item.device }} → /dev/mapper/{{ item.name }}
          {% endfor %}

          Next steps:
          1. Verify mount: df -h {{ longhorn_mount_point }}
          2. Check LVM status: vgs && lvs
          3. Configure Longhorn to use {{ longhorn_mount_point }}
          4. Reboot to verify auto-unlock works
