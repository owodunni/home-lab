---
# Phase 6: Monitoring Stack (Prometheus + Grafana)
# Deploys comprehensive monitoring with HTTPS access via cert-manager

- name: Phase 6a - Pre-deployment Overview
  hosts: control_plane
  become: true
  gather_facts: true
  run_once: true

  vars:
    monitoring_namespace: "monitoring"
    prometheus_chart_version: "67.4.0"  # kube-prometheus-stack chart version
    prometheus_domain: "prometheus.jardoole.xyz"
    grafana_domain: "grafana.jardoole.xyz"

  tasks:
    - name: Display Phase 6 overview
      ansible.builtin.debug:
        msg: |
          Phase 6: Monitoring Stack
          =========================
          - Deploy kube-prometheus-stack {{ prometheus_chart_version }}
          - Configure HTTPS ingress with cert-manager certificates
          - Set up monitoring for K3s cluster and applications

          External HTTPS access:
          - Prometheus: https://{{ prometheus_domain }}
          - Grafana: https://{{ grafana_domain }}

- name: Phase 6b - Deploy Monitoring Stack Application
  import_playbook: ../../apps/kube-prometheus-stack/app.yml

- name: Phase 6c - Post-deployment Verification
  hosts: control_plane
  become: true
  gather_facts: true
  run_once: true

  vars:
    monitoring_namespace: "monitoring"
    prometheus_chart_version: "67.4.0"
    prometheus_domain: "prometheus.jardoole.xyz"
    grafana_domain: "grafana.jardoole.xyz"

  tasks:
    # Note: Certificates are auto-created by cert-manager from Ingress annotations
    # The cert-manager.io/cluster-issuer annotation triggers automatic Certificate creation

    - name: Wait for certificates to be ready
      kubernetes.core.k8s_info:
        api_version: cert-manager.io/v1
        kind: Certificate
        name: "{{ item }}"
        namespace: "{{ monitoring_namespace }}"
        kubeconfig: /etc/rancher/k3s/k3s.yaml
        wait: true
        wait_condition:
          type: Ready
          status: "True"
        wait_timeout: 300
      loop:
        - prometheus-tls-secret  # Cert-manager auto-created from ingress secretName
        - grafana-tls-secret     # Cert-manager auto-created from ingress secretName

    - name: Get monitoring services status
      kubernetes.core.k8s_info:
        api_version: v1
        kind: Service
        namespace: "{{ monitoring_namespace }}"
        kubeconfig: /etc/rancher/k3s/k3s.yaml
      register: monitoring_services

    - name: Get ingress status
      kubernetes.core.k8s_info:
        api_version: networking.k8s.io/v1
        kind: Ingress
        namespace: "{{ monitoring_namespace }}"
        kubeconfig: /etc/rancher/k3s/k3s.yaml
      register: ingress_status

    - name: Get certificate status
      kubernetes.core.k8s_info:
        api_version: cert-manager.io/v1
        kind: Certificate
        namespace: "{{ monitoring_namespace }}"
        kubeconfig: /etc/rancher/k3s/k3s.yaml
      register: certificate_status

    - name: Display Phase 6 completion
      ansible.builtin.debug:
        msg: |
          Phase 6 Complete: Monitoring Stack
          ==================================
          ✓ Prometheus stack deployed in {{ monitoring_namespace }} namespace
          ✓ Grafana dashboard deployed with persistent storage
          ✓ Services: {{ monitoring_services.resources | length }} running
          ✓ Ingress routes: {{ ingress_status.resources | length }} configured
          ✓ SSL certificates: {{ certificate_status.resources | length }} issued

          External HTTPS Access:
          - Prometheus: https://{{ prometheus_domain }}
          - Grafana: https://{{ grafana_domain }}
            Default login: admin / {{ vault_grafana_admin_password }}

          Certificate Status:
          {% for cert in certificate_status.resources %}
          - {{ cert.metadata.name }}: {{
              cert.status.conditions |
              selectattr('type', 'equalto', 'Ready') |
              map(attribute='status') | first | default('Pending')
            }}
          {% endfor %}


          Monitoring Features:
          - K3s cluster metrics collection
          - Node and pod monitoring dashboards
          - Persistent storage for historical data
          - Automatic SSL certificate management
          - External HTTPS access via Traefik + cert-manager

          Ready for production monitoring and alerting setup!
