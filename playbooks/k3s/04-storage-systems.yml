---
# Phase 4: Storage Systems (NFS)
# Installs NFS storage provisioner for persistent volumes backed by Beelink filesystem

- name: Phase 4a - Install NFS Prerequisites on All Nodes
  hosts: k3s_cluster
  become: true
  gather_facts: true

  tasks:
    - name: Install NFS client packages
      ansible.builtin.package:
        name:
          - nfs-common  # Required for NFS client mounts
        state: present

- name: Phase 4b - Pre-deployment Verification
  hosts: control_plane
  become: true
  gather_facts: true
  run_once: true

  tasks:
    - name: Display Phase 4 overview
      ansible.builtin.debug:
        msg: |
          Phase 4: Storage Systems (NFS)
          ==============================
          - Install NFS subdir external provisioner
          - Configure NFS as default storage class
          - Verify storage system functionality

          Infrastructure:
          - NFS server: beelink (192.168.1.76) with 4TB MergerFS pool at /mnt/storage
          - 3 control plane nodes (pi-cm5-1,2,3)

          Storage Layout on Beelink:
          - /mnt/storage/k8s-apps → Kubernetes app configs (restic backup to MinIO)
          - /mnt/storage/media    → Media files (restic backup to MinIO)

          Storage System:
          - NFS (default):
            - ReadWriteMany (RWX) NFS-backed volumes
            - Direct filesystem access via SSH
            - Backed up via restic to MinIO S3
            - SnapRAID parity for disaster recovery
            - Best for: All persistent volume needs

    - name: Verify NFS server is accessible
      ansible.builtin.command:
        cmd: showmount -e beelink
      register: nfs_exports
      changed_when: false
      failed_when: nfs_exports.rc != 0

    - name: Display NFS exports verification
      ansible.builtin.debug:
        msg: |
          ✓ Verified NFS server is accessible
          {{ nfs_exports.stdout }}

- name: Phase 4c - Deploy NFS Storage Provisioner
  import_playbook: ../../apps/nfs-storage/app.yml

- name: Phase 4d - Storage Systems Verification
  hosts: control_plane
  become: true
  gather_facts: false
  run_once: true

  tasks:
    - name: Get all storage classes
      kubernetes.core.k8s_info:
        api_version: storage.k8s.io/v1
        kind: StorageClass
        kubeconfig: /etc/rancher/k3s/k3s.yaml
      register: all_storage_classes

    - name: Verify NFS provisioner pod is running
      kubernetes.core.k8s_info:
        api_version: v1
        kind: Pod
        namespace: kube-system
        label_selectors:
          - app=nfs-subdir-external-provisioner
        kubeconfig: /etc/rancher/k3s/k3s.yaml
      register: nfs_provisioner_pods

    - name: Verify NFS storage class is default
      ansible.builtin.assert:
        that:
          - all_storage_classes.resources | selectattr('metadata.name', 'equalto', 'nfs') | list | length == 1
        fail_msg: "NFS storage class not found!"
        success_msg: "✓ NFS storage class created successfully"

    - name: Display Phase 4 final summary
      ansible.builtin.debug:
        msg: |
          Phase 4 Complete: Storage Systems (NFS)
          =======================================
          ✓ NFS: Default storage class (RWX, Beelink filesystem)

          Storage classes available:
          {% for sc in all_storage_classes.resources %}
          - {{ sc.metadata.name }}
            Provisioner: {{ sc.provisioner }}
            Default: {{ 'yes' if (sc.metadata.annotations | default({})).
                        get('storageclass.kubernetes.io/is-default-class') == 'true'
                        else 'no' }}
          {% endfor %}

          NFS Provisioner:
          - Pods running: {{ nfs_provisioner_pods.resources | length }}
          - NFS Server: beelink
          - NFS Path: /mnt/storage

          Backup Strategy:
          - k8s-apps: /mnt/storage/k8s-apps → s3://restic-backups (daily 3 AM)
          - Media:    /mnt/storage/media    → s3://restic-backups (daily 3 AM)
          - Redundancy: SnapRAID parity protection (daily 4 AM)

          Ready for application deployment with NFS storage!
