---
# Phase 3: Storage Systems (Longhorn)
# Installs Longhorn distributed storage system for persistent volumes
# Note: MinIO backup integration will be added in a future phase

- name: Phase 3a - Install Longhorn Prerequisites on All Nodes
  hosts: k3s_cluster
  become: true
  gather_facts: true

  tasks:
    - name: Install Longhorn prerequisites
      ansible.builtin.package:
        name:
          - open-iscsi  # Required for iSCSI block storage
          - nfs-common  # Required for RWX volumes (future)
        state: present

    - name: Enable and start iscsid service
      ansible.builtin.systemd:
        name: iscsid
        enabled: true
        state: started

- name: Phase 3b - Deploy Longhorn Storage System
  hosts: control_plane
  become: true
  gather_facts: true
  run_once: true

  vars:
    longhorn_namespace: "longhorn-system"
    longhorn_chart_version: "1.7.2"  # Latest stable as of 2024

  tasks:
    - name: Display Phase 3 overview
      ansible.builtin.debug:
        msg: |
          Phase 3: Storage Systems (Longhorn)
          ===================================
          - Install Longhorn {{ longhorn_chart_version }} distributed storage
          - Configure basic storage class with 1 replica (matches infrastructure)
          - Set up Longhorn UI access via Traefik ingress
          - Verify storage system functionality

          Infrastructure:
          - 1 worker node (beelink) with 6TB storage at /var/lib/longhorn
          - 3 control plane nodes (pi-cm5-1,2,3)

          Longhorn provides:
          - Distributed block storage with automatic failover
          - CSI-compliant dynamic volume provisioning
          - Snapshot and backup capabilities (backup config in future phase)
          - Web UI for management

    - name: Verify Longhorn storage path exists on worker nodes
      ansible.builtin.stat:
        path: /var/lib/longhorn
      register: longhorn_path
      delegate_to: "{{ item }}"
      loop: "{{ groups['workers'] }}"
      failed_when: >
        not longhorn_path.stat.exists or
        not longhorn_path.stat.isdir

    - name: Display storage path verification
      ansible.builtin.debug:
        msg: |
          ✓ Verified /var/lib/longhorn exists on worker nodes
          - This path should be mounted from LUKS-encrypted LVM volume
          - Total storage capacity: ~6TB across {{ groups['workers'] | length }} node(s)

    - name: Restart CoreDNS for fresh DNS resolution
      ansible.builtin.command:
        cmd: kubectl -n kube-system rollout restart deployment coredns
      environment:
        KUBECONFIG: /etc/rancher/k3s/k3s.yaml
      changed_when: true
      register: coredns_restart

    - name: Wait for CoreDNS to be ready
      kubernetes.core.k8s_info:
        api_version: apps/v1
        kind: Deployment
        name: coredns
        namespace: kube-system
        kubeconfig: /etc/rancher/k3s/k3s.yaml
        wait: true
        wait_condition:
          type: Available
          status: "True"
        wait_timeout: 120

    - name: Create Longhorn namespace
      kubernetes.core.k8s:
        name: "{{ longhorn_namespace }}"
        api_version: v1
        kind: Namespace
        state: present
        kubeconfig: /etc/rancher/k3s/k3s.yaml

    - name: Install Longhorn using Helm
      kubernetes.core.helm:
        name: longhorn
        chart_ref: longhorn/longhorn
        release_namespace: "{{ longhorn_namespace }}"
        create_namespace: true
        chart_version: "{{ longhorn_chart_version }}"
        kubeconfig: /etc/rancher/k3s/k3s.yaml
        values:
          defaultSettings:
            # Replica count: 1 (we have 1 worker node with storage)
            defaultReplicaCount: 1
            # Data locality: prefer storing data on same node as workload
            defaultDataLocality: best-effort
            # Soft anti-affinity: allow replicas on same node if needed
            replicaSoftAntiAffinity: true
            # Storage over-provisioning: allow 2x thin provisioning
            storageOverProvisioningPercentage: 100
            # Reserve 10% of storage space as buffer
            storageMinimalAvailablePercentage: 10
            # Disable upgrade checker (air-gapped or controlled updates)
            upgradeChecker: false
          longhornUI:
            replicas: 1
          persistence:
            # Make Longhorn the default storage class
            defaultClass: true
            defaultFsType: ext4
            defaultClassReplicaCount: 1  # Matches infrastructure
            # Retain volumes when PVC is deleted (safety)
            reclaimPolicy: Retain
          csi:
            # K3s-specific kubelet path (different from standard K8s)
            kubeletRootDir: /var/lib/rancher/k3s/agent/kubelet
          longhornManager:
            nodeSelector:
              kubernetes.io/os: linux
          longhornDriver:
            nodeSelector:
              kubernetes.io/os: linux

    - name: Wait for Longhorn manager to be ready
      kubernetes.core.k8s_info:
        api_version: apps/v1
        kind: DaemonSet
        name: longhorn-manager
        namespace: "{{ longhorn_namespace }}"
        kubeconfig: /etc/rancher/k3s/k3s.yaml
        wait: true
        wait_timeout: 300
      register: longhorn_manager

    - name: Wait for Longhorn UI to be ready
      kubernetes.core.k8s_info:
        api_version: apps/v1
        kind: Deployment
        name: longhorn-ui
        namespace: "{{ longhorn_namespace }}"
        kubeconfig: /etc/rancher/k3s/k3s.yaml
        wait: true
        wait_condition:
          type: Available
          status: "True"
        wait_timeout: 300

    - name: Create Longhorn ingress for UI access
      kubernetes.core.k8s:
        definition:
          apiVersion: networking.k8s.io/v1
          kind: Ingress
          metadata:
            name: longhorn-ui
            namespace: "{{ longhorn_namespace }}"
            annotations:
              traefik.ingress.kubernetes.io/router.entrypoints: web
          spec:
            ingressClassName: traefik
            rules:
              - host: longhorn.internal
                http:
                  paths:
                    - path: /
                      pathType: Prefix
                      backend:
                        service:
                          name: longhorn-frontend
                          port:
                            number: 80
        kubeconfig: /etc/rancher/k3s/k3s.yaml

    - name: Get Longhorn system status
      kubernetes.core.k8s_info:
        api_version: v1
        kind: Pod
        namespace: "{{ longhorn_namespace }}"
        label_selectors:
          - app=longhorn-manager
        kubeconfig: /etc/rancher/k3s/k3s.yaml
      register: longhorn_pods

    - name: Get storage classes
      kubernetes.core.k8s_info:
        api_version: storage.k8s.io/v1
        kind: StorageClass
        kubeconfig: /etc/rancher/k3s/k3s.yaml
      register: storage_classes

    - name: Verify default storage class exists
      ansible.builtin.assert:
        that:
          - storage_classes.resources | selectattr('metadata.name', 'equalto', 'longhorn') | list | length == 1
        fail_msg: "Longhorn default storage class not found!"
        success_msg: "✓ Longhorn storage class created successfully"

    - name: Display Phase 3 completion
      ansible.builtin.debug:
        msg: |
          Phase 3 Complete: Storage Systems (Longhorn)
          ============================================
          ✓ Longhorn {{ longhorn_chart_version }} installed in {{ longhorn_namespace }} namespace
          ✓ Longhorn manager pods: {{ longhorn_pods.resources | length }} running
          ✓ Storage classes available: {{ storage_classes.resources | selectattr('metadata.name', 'match', '^longhorn.*') | list | length }}

          Available storage classes:
          {% for sc in storage_classes.resources %}
          {% if 'longhorn' in sc.metadata.name %}
          - {{ sc.metadata.name }}
            Provisioner: {{ sc.provisioner }}
            Reclaim Policy: {{ sc.reclaimPolicy }}
            Default: {{ 'yes' if sc.metadata.name == 'longhorn' else 'no' }}
          {% endif %}
          {% endfor %}

          Access Longhorn UI:
          - http://longhorn.internal (via Traefik)
          - Add to /etc/hosts or configure local DNS

          Storage Configuration:
          - Replica count: 1 (matches 1 worker node with storage)
          - Data locality: best-effort (prefer local node)
          - Storage path: /var/lib/longhorn on worker nodes
          - Total capacity: ~6TB

          Next Steps:
          - Deploy applications with PersistentVolumeClaims
          - Monitor storage usage in Longhorn UI
          - Future: Add MinIO S3 backup integration

          Ready for application deployment with persistent storage!
